{% extends "base.html" %}
{% set active_tab = "finance/invoices" %}
{% block content %}
<div x-data="invoiceEditApp()" x-init="loadData()" class="max-w-4xl mx-auto space-y-6">

  <div class="flex items-center gap-4 mb-2">
    <a href="/finance/invoices" class="text-sm text-sap-600 dark:text-sap-400 hover:underline">&larr; Back to Invoices</a>
    <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100" x-text="invoiceId ? 'Edit Invoice' : 'New Invoice'"></h2>
  </div>

  <!-- Invoice Form -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Period -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Year</label>
        <select x-model.number="form.period_year" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-2 text-sm">
          <template x-for="y in yearOptions" :key="y">
            <option :value="y" x-text="y"></option>
          </template>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Month</label>
        <select x-model.number="form.period_month" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-2 text-sm">
          <template x-for="m in 12" :key="m">
            <option :value="m" x-text="monthNames[m-1]"></option>
          </template>
        </select>
      </div>
      <!-- Client -->
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Client Name</label>
        <input x-model="form.client_name" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Invoice Number</label>
        <input x-model="form.invoice_number" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-2 text-sm">
      </div>
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Client Address (optional)</label>
        <input x-model="form.client_address" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">VAT %</label>
        <input x-model.number="vatPercent" type="number" step="0.5" min="0" max="100"
               class="w-24 border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-2 text-sm">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
        <select x-model="form.status" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-2 text-sm">
          <option value="PENDING">Pending</option>
          <option value="PAID">Paid</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Items Table -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100 mb-4">Items</h3>
    <table class="w-full text-sm mb-4">
      <thead class="bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
        <tr>
          <th class="px-3 py-2 text-left font-medium">Description</th>
          <th class="px-3 py-2 text-right font-medium w-20">Qty</th>
          <th class="px-3 py-2 text-center font-medium w-24">Unit</th>
          <th class="px-3 py-2 text-right font-medium w-28">Unit Price</th>
          <th class="px-3 py-2 text-right font-medium w-28">Total</th>
          <th class="px-3 py-2 w-12"></th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
        <template x-for="(item, idx) in items" :key="idx">
          <tr>
            <td class="px-3 py-2">
              <input x-model="item.description" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded px-2 py-1 text-sm">
            </td>
            <td class="px-3 py-2">
              <input x-model.number="item.quantity" type="number" step="0.25" min="0" @input="calcLineTotal(item)"
                     class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded px-2 py-1 text-sm text-right">
            </td>
            <td class="px-3 py-2">
              <select x-model="item.unit" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded px-2 py-1 text-sm">
                <option value="HOURS">Hours</option>
                <option value="DAYS">Days</option>
              </select>
            </td>
            <td class="px-3 py-2">
              <input x-model.number="item.unit_price" type="number" step="0.01" min="0" @input="calcLineTotal(item)"
                     class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded px-2 py-1 text-sm text-right">
            </td>
            <td class="px-3 py-2 text-right font-mono text-gray-800 dark:text-gray-100" x-text="item.line_total.toFixed(2)"></td>
            <td class="px-3 py-2 text-center">
              <button @click="items.splice(idx, 1)" class="text-red-600 dark:text-red-400 hover:underline text-xs">X</button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
    <button @click="addItem()" class="text-sm text-sap-600 dark:text-sap-400 hover:underline">+ Add Item</button>

    <!-- Totals -->
    <div class="mt-4 border-t dark:border-gray-700 pt-4 space-y-1">
      <div class="flex justify-between text-sm">
        <span class="text-gray-600 dark:text-gray-300">Subtotal:</span>
        <span class="font-mono text-gray-800 dark:text-gray-100" x-text="subtotal().toFixed(2) + ' EUR'"></span>
      </div>
      <div x-show="vatPercent > 0" class="flex justify-between text-sm">
        <span class="text-gray-600 dark:text-gray-300" x-text="'VAT (' + vatPercent + '%):'"></span>
        <span class="font-mono text-gray-800 dark:text-gray-100" x-text="vatAmount().toFixed(2) + ' EUR'"></span>
      </div>
      <div class="flex justify-between text-sm font-bold border-t dark:border-gray-700 pt-1">
        <span class="text-gray-800 dark:text-gray-100">Total:</span>
        <span class="font-mono text-gray-800 dark:text-gray-100" x-text="grandTotal().toFixed(2) + ' EUR'"></span>
      </div>
    </div>
  </div>

  <!-- Notes + Document -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes (optional)</label>
        <textarea x-model="form.notes" rows="3" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-2 text-sm"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Document</label>
        <template x-if="form.document_id">
          <div class="flex items-center gap-2 text-sm">
            <a :href="'/api/finance/documents/' + form.document_id + '/download'" target="_blank" class="text-sap-600 dark:text-sap-400 hover:underline">View document</a>
            <button @click="form.document_id = null" class="text-red-600 dark:text-red-400 hover:underline text-xs">Remove</button>
          </div>
        </template>
        <template x-if="!form.document_id">
          <div class="flex items-center gap-3">
            <input type="file" @change="uploadFile($event)" class="text-sm text-gray-600 dark:text-gray-300">
            <span x-show="uploading" class="text-xs text-gray-400 dark:text-gray-500">Uploading...</span>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div x-show="formError" class="text-sm text-red-600 dark:text-red-400" x-text="formError"></div>
  <div class="flex gap-3">
    <button @click="save()" class="bg-sap-600 hover:bg-sap-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition">Save</button>
    <button x-show="invoiceId" @click="generatePdf()" :disabled="generatingPdf" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition disabled:opacity-50">
      <span x-text="generatingPdf ? 'Generating...' : 'Generate PDF'"></span>
    </button>
    <a href="/finance/invoices" class="px-6 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">Cancel</a>
  </div>
</div>

<script>
function invoiceEditApp() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const yearOptions = [];
  for (let y = currentYear - 5; y <= currentYear + 1; y++) yearOptions.push(y);

  return {
    invoiceId: {{ invoice_id|tojson if invoice_id else 'null' }},
    yearOptions,
    monthNames: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
    vatPercent: 0,
    uploading: false,
    generatingPdf: false,
    formError: '',
    form: {
      period_year: currentYear,
      period_month: now.getMonth() + 1,
      client_name: '',
      client_address: '',
      invoice_number: '',
      status: 'PENDING',
      notes: '',
      document_id: null,
    },
    items: [{description: '', quantity: 1, unit: 'HOURS', unit_price: 0, line_total: 0}],

    async loadData() {
      if (!this.invoiceId) return;
      const resp = await fetch('/api/finance/invoices/' + this.invoiceId);
      if (!resp.ok) return;
      const data = await resp.json();
      this.form = {
        period_year: data.period_year,
        period_month: data.period_month,
        client_name: data.client_name,
        client_address: data.client_address || '',
        invoice_number: data.invoice_number,
        status: data.status,
        notes: data.notes || '',
        document_id: data.document_id,
      };
      this.vatPercent = Math.round(data.vat_rate * 10000) / 100;
      if (data.items && data.items.length > 0) {
        this.items = data.items.map(i => ({
          description: i.description,
          quantity: i.quantity,
          unit: i.unit,
          unit_price: i.unit_price,
          line_total: i.line_total,
        }));
      }
    },

    addItem() {
      this.items.push({description: '', quantity: 1, unit: 'HOURS', unit_price: 0, line_total: 0});
    },

    calcLineTotal(item) {
      item.line_total = Math.round((item.quantity || 0) * (item.unit_price || 0) * 100) / 100;
    },

    subtotal() {
      return Math.round(this.items.reduce((s, i) => s + (i.line_total || 0), 0) * 100) / 100;
    },

    vatAmount() {
      return Math.round(this.subtotal() * (this.vatPercent / 100) * 100) / 100;
    },

    grandTotal() {
      return Math.round((this.subtotal() + this.vatAmount()) * 100) / 100;
    },

    async uploadFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      this.uploading = true;
      const fd = new FormData();
      fd.append('file', file);
      const resp = await fetch('/api/finance/upload', {method: 'POST', body: fd});
      const doc = await resp.json();
      this.form.document_id = doc.id;
      this.uploading = false;
    },

    async save() {
      this.formError = '';
      if (!this.form.client_name.trim()) { this.formError = 'Client name is required.'; return; }
      if (!this.form.invoice_number.trim()) { this.formError = 'Invoice number is required.'; return; }
      // Recalculate all line totals
      this.items.forEach(i => this.calcLineTotal(i));
      const payload = {
        ...this.form,
        vat_rate: this.vatPercent / 100,
        items: this.items.filter(i => i.description.trim()),
      };
      let resp;
      if (this.invoiceId) {
        resp = await fetch('/api/finance/invoices/' + this.invoiceId, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
      } else {
        resp = await fetch('/api/finance/invoices', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
      }
      if (!resp.ok) {
        const d = await resp.json().catch(() => ({}));
        this.formError = d.error || 'Error saving invoice.';
        return;
      }
      const data = await resp.json();
      if (!this.invoiceId) {
        window.location.href = '/finance/invoices/' + data.id + '/edit';
      } else {
        await this.loadData();
      }
    },

    async generatePdf() {
      this.generatingPdf = true;
      this.formError = '';
      const resp = await fetch('/api/finance/invoices/' + this.invoiceId + '/generate-pdf', {method: 'POST'});
      if (!resp.ok) {
        const d = await resp.json().catch(() => ({}));
        this.formError = d.error || 'Error generating PDF.';
      } else {
        await this.loadData();
      }
      this.generatingPdf = false;
    },
  }
}
</script>
{% endblock %}
