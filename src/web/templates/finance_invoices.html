{% extends "base.html" %}
{% set active_tab = "finance/invoices" %}
{% block content %}
<!-- Finance Tabs -->
<div class="max-w-6xl mx-auto mb-4">
  <nav class="flex gap-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-1">
    <a href="/finance/summary" class="px-4 py-2 rounded-lg text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Summary</a>
    <a href="/finance/expenses" class="px-4 py-2 rounded-lg text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Expenses</a>
    <a href="/finance/invoices" class="px-4 py-2 rounded-lg text-sm font-medium transition bg-sap-600 text-white">Invoices</a>
    <a href="/finance/settings" class="px-4 py-2 rounded-lg text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Settings</a>
  </nav>
</div>

<div x-data="invoicesApp()" x-init="loadData()" class="max-w-6xl mx-auto space-y-4">

  <!-- Header + Filters -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
    <div class="flex flex-wrap items-center gap-4">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Invoices</h2>
      <div class="flex items-center gap-2 ml-auto flex-wrap">
        <select x-model.number="filterYear" @change="loadData()" class="border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-1.5 text-sm">
          <option :value="0">All years</option>
          <template x-for="y in yearOptions" :key="y">
            <option :value="y" x-text="y"></option>
          </template>
        </select>
        <select x-model.number="filterMonth" @change="loadData()" class="border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-1.5 text-sm">
          <option :value="0">All months</option>
          <template x-for="m in 12" :key="m">
            <option :value="m" x-text="monthNames[m-1]"></option>
          </template>
        </select>
        <input x-model="filterClient" @input.debounce.300ms="loadData()" placeholder="Client..." class="border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-lg px-3 py-1.5 text-sm w-36">
        <a :href="csvExportUrl()" class="text-sm text-sap-600 dark:text-sap-400 hover:underline">Export CSV</a>
        <a href="/finance/invoices/new" class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">New Invoice</a>
      </div>
    </div>
  </div>

  <!-- Invoices Table -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
    <table class="w-full text-sm">
      <thead class="bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
        <tr>
          <th class="px-4 py-3 text-left font-medium">Period</th>
          <th class="px-4 py-3 text-left font-medium">Client</th>
          <th class="px-4 py-3 text-left font-medium">Invoice No</th>
          <th class="px-4 py-3 text-right font-medium">Total (EUR)</th>
          <th class="px-4 py-3 text-center font-medium">VAT%</th>
          <th class="px-4 py-3 text-center font-medium">Status</th>
          <th class="px-4 py-3 text-center font-medium">Doc</th>
          <th class="px-4 py-3 text-center font-medium">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
        <template x-for="inv in invoices" :key="inv.id">
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
            <td class="px-4 py-3 text-gray-800 dark:text-gray-100" x-text="inv.period_year + '-' + String(inv.period_month).padStart(2, '0')"></td>
            <td class="px-4 py-3 text-gray-600 dark:text-gray-300" x-text="inv.client_name"></td>
            <td class="px-4 py-3 font-mono text-gray-800 dark:text-gray-100" x-text="inv.invoice_number"></td>
            <td class="px-4 py-3 text-right font-mono text-gray-800 dark:text-gray-100" x-text="inv.total.toFixed(2)"></td>
            <td class="px-4 py-3 text-center text-gray-600 dark:text-gray-300" x-text="(inv.vat_rate * 100).toFixed(0) + '%'"></td>
            <td class="px-4 py-3 text-center">
              <span class="text-xs px-2 py-0.5 rounded font-semibold"
                    :class="inv.status === 'PAID' ? 'bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300' : 'bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300'"
                    x-text="inv.status"></span>
            </td>
            <td class="px-4 py-3 text-center">
              <template x-if="inv.document_id">
                <a :href="'/api/finance/documents/' + inv.document_id + '/download'" target="_blank" class="text-sap-600 dark:text-sap-400 hover:underline text-xs">View</a>
              </template>
              <template x-if="!inv.document_id">
                <span class="text-xs text-gray-400 dark:text-gray-500">--</span>
              </template>
            </td>
            <td class="px-4 py-3 text-center">
              <a :href="'/finance/invoices/' + inv.id + '/edit'" class="text-sm text-sap-600 dark:text-sap-400 hover:underline mr-2">Edit</a>
              <button @click="deleteInvoice(inv.id)" class="text-sm text-red-600 dark:text-red-400 hover:underline">Delete</button>
            </td>
          </tr>
        </template>
        <tr x-show="invoices.length === 0">
          <td colspan="8" class="px-4 py-8 text-center text-gray-400 dark:text-gray-500 text-sm">No invoices found.</td>
        </tr>
      </tbody>
      <tfoot class="bg-gray-50 dark:bg-gray-700 font-semibold">
        <tr>
          <td colspan="3" class="px-4 py-3 text-gray-700 dark:text-gray-200">Total</td>
          <td class="px-4 py-3 text-right font-mono text-gray-800 dark:text-gray-100" x-text="total.toFixed(2)"></td>
          <td colspan="2" class="px-4 py-3 text-center text-xs text-gray-400 dark:text-gray-500" x-text="invoiceCount + ' invoice(s)'"></td>
          <td colspan="2" class="px-4 py-3 text-center text-xs text-amber-600 dark:text-amber-400" x-text="'Pending: ' + pending.toFixed(2)"></td>
        </tr>
      </tfoot>
    </table>
  </div>

</div>

<script>
function invoicesApp() {
  const now = new Date();
  const currentYear = now.getFullYear();
  const yearOptions = [];
  for (let y = currentYear - 5; y <= currentYear + 1; y++) yearOptions.push(y);

  return {
    invoices: [],
    total: 0,
    pending: 0,
    invoiceCount: 0,
    filterYear: currentYear,
    filterMonth: 0,
    filterClient: '',
    yearOptions,
    monthNames: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],

    async loadData() {
      let url = '/api/finance/invoices?';
      if (this.filterYear) url += 'year=' + this.filterYear + '&';
      if (this.filterMonth) url += 'month=' + this.filterMonth + '&';
      if (this.filterClient) url += 'client=' + encodeURIComponent(this.filterClient) + '&';
      const resp = await fetch(url);
      const data = await resp.json();
      this.invoices = data.invoices;
      this.total = data.total;
      this.pending = data.pending;
      this.invoiceCount = data.count;
    },

    csvExportUrl() {
      let url = '/api/finance/invoices/export-csv?';
      if (this.filterYear) url += 'year=' + this.filterYear + '&';
      if (this.filterMonth) url += 'month=' + this.filterMonth + '&';
      return url;
    },

    async deleteInvoice(id) {
      await fetch('/api/finance/invoices/' + id, {method: 'DELETE'});
      await this.loadData();
    },
  }
}
</script>
{% endblock %}
