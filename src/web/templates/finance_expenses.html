{% extends "base.html" %}
{% set active_tab = "finance/expenses" %}
{% block content %}
<!-- Finance Tabs -->
<div class="max-w-6xl mx-auto mb-4">
  <nav class="flex gap-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-1">
    <a href="/finance/summary" class="px-4 py-2 rounded-lg text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Summary</a>
    <a href="/finance/expenses" class="px-4 py-2 rounded-lg text-sm font-medium transition bg-sap-600 text-white">Expenses</a>
    <a href="/finance/invoices" class="px-4 py-2 rounded-lg text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Invoices</a>
    <a href="/finance/settings" class="px-4 py-2 rounded-lg text-sm font-medium transition text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Settings</a>
  </nav>
</div>

<div x-data="expensesApp()" x-init="loadData()" class="max-w-6xl mx-auto space-y-4">

  <!-- Header + Filters -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4">
    <div class="flex flex-wrap items-center gap-4">
      <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Expenses</h2>
      <div class="flex items-center gap-2 ml-auto flex-wrap">
        <div class="flex items-center gap-1">
          <input type="number" :value="filterYear || ''" @input="filterYear = parseInt($event.target.value) || 0" @change="loadData()" placeholder="All years" min="2000" max="2100"
                 class="w-24 border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-1.5 text-sm">
          <button x-show="filterYear" @click="filterYear = 0; loadData()" class="text-xs text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300" title="Show all years">All</button>
        </div>
        <select x-model.number="filterMonth" @change="loadData()" class="border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-1.5 text-sm">
          <option :value="0">All months</option>
          <template x-for="m in 12" :key="m">
            <option :value="m" x-text="monthNames[m-1]"></option>
          </template>
        </select>
        <select x-model.number="filterCategory" @change="loadData()" class="border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-1.5 text-sm">
          <option :value="0">All categories</option>
          <template x-for="c in categories" :key="c.id">
            <option :value="c.id" x-text="c.name"></option>
          </template>
        </select>
        <a :href="csvExportUrl()" class="text-sm text-sap-600 dark:text-sap-400 hover:underline">Export CSV</a>
        <button @click="showBulk = !showBulk" class="border border-sap-600 text-sap-600 dark:text-sap-400 dark:border-sap-400 hover:bg-sap-50 dark:hover:bg-sap-900/20 px-4 py-2 rounded-lg text-sm font-medium transition" x-text="showBulk ? 'Cancel Bulk' : 'Bulk Import'"></button>
        <button @click="openCreate()" class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">New Expense</button>
      </div>
    </div>
  </div>

  <!-- Expenses Table -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">

    <!-- Bulk Import -->
    <div x-show="showBulk" class="p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50" x-transition>
      <h3 class="text-sm font-semibold text-gray-800 dark:text-white mb-2">Bulk Import Expenses</h3>
      <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Select multiple PDF/image files. Each file will create an expense with the amount auto-detected via OCR. You can edit each expense afterwards.</p>
      <div class="flex items-center gap-3">
        <input type="file" multiple accept=".pdf,.jpg,.jpeg,.png" @change="bulkFiles = $event.target.files" class="text-sm text-gray-600 dark:text-gray-300">
        <button x-show="bulkFiles && bulkFiles.length > 0 && !bulkUploading" @click="bulkImport()"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition"
                x-text="'Upload ' + (bulkFiles ? bulkFiles.length : 0) + ' file(s)'"></button>
        <span x-show="bulkUploading" class="text-xs text-amber-600 dark:text-amber-400" x-text="'Processing ' + bulkProgress + '...'"></span>
      </div>
      <div x-show="bulkResults.length > 0" class="mt-3 space-y-1">
        <template x-for="r in bulkResults" :key="r.expense_id">
          <div class="flex items-center gap-2 text-xs">
            <span class="text-green-600 dark:text-green-400">OK</span>
            <span class="text-gray-600 dark:text-gray-300" x-text="r.file_name"></span>
            <span class="font-mono text-gray-800 dark:text-white" x-text="r.amount.toFixed(2) + ' EUR'"></span>
            <span class="text-gray-400 dark:text-gray-500" x-text="r.period"></span>
          </div>
        </template>
      </div>
    </div>

    <table class="w-full text-sm">
      <thead class="bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
        <tr>
          <th class="px-4 py-3 text-left font-medium">Period</th>
          <th class="px-4 py-3 text-left font-medium">Category</th>
          <th class="px-4 py-3 text-left font-medium">Merchant</th>
          <th class="px-4 py-3 text-left font-medium">Amount (EUR)</th>
          <th class="px-4 py-3 text-left font-medium">Doc</th>
          <th class="px-4 py-3 text-left font-medium">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
        <template x-for="exp in expenses" :key="exp.id">
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
            <td class="px-4 py-3 text-gray-800 dark:text-white" x-text="exp.period_year + '-' + String(exp.period_month).padStart(2, '0')"></td>
            <td class="px-4 py-3 text-gray-600 dark:text-gray-300" x-text="exp.category_name"></td>
            <td class="px-4 py-3 text-gray-600 dark:text-gray-300" x-text="exp.merchant || 'â€”'"></td>
            <td class="px-4 py-3 text-left font-mono text-gray-800 dark:text-white" x-text="exp.amount.toFixed(2)"></td>
            <td class="px-4 py-3 text-left">
              <template x-if="exp.document_id">
                <a :href="'/api/finance/documents/' + exp.document_id + '/download'" target="_blank" class="text-sap-600 dark:text-sap-400 hover:underline text-xs">View</a>
              </template>
              <template x-if="!exp.document_id && exp.document_not_required">
                <span class="text-xs text-gray-400 dark:text-gray-500">N/A</span>
              </template>
              <template x-if="!exp.document_id && !exp.document_not_required">
                <span class="text-xs text-red-500 dark:text-red-400 font-semibold">MISSING</span>
              </template>
            </td>
            <td class="px-4 py-3 text-left">
              <button @click="openEdit(exp)" class="text-sm text-sap-600 dark:text-sap-400 hover:underline mr-2">Edit</button>
              <button @click="deleteExpense(exp.id)" class="text-sm text-red-600 dark:text-red-400 hover:underline">Delete</button>
            </td>
          </tr>
        </template>
        <tr x-show="expenses.length === 0">
          <td colspan="6" class="px-4 py-8 text-center text-gray-400 dark:text-gray-500 text-sm">No expenses found.</td>
        </tr>
      </tbody>
      <tfoot class="bg-gray-50 dark:bg-gray-700 font-semibold">
        <tr>
          <td colspan="3" class="px-4 py-3 text-gray-700 dark:text-white">Total</td>
          <td class="px-4 py-3 text-left font-mono text-gray-800 dark:text-white" x-text="total.toFixed(2)"></td>
          <td colspan="2" class="px-4 py-3 text-left text-xs text-gray-400 dark:text-gray-500" x-text="expenseCount + ' expense(s)'"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Create/Edit Modal -->
  <div x-show="showModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" @click.self="showModal = false" x-transition>
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 w-full max-w-lg mx-4 p-6" @click.stop>
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4" x-text="editingId ? 'Edit Expense' : 'New Expense'"></h3>
      <div class="space-y-4">
        <!-- Period -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Year</label>
            <input type="number" x-model.number="form.period_year" min="2000" max="2100"
                   class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-2 text-sm">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Month</label>
            <select x-model.number="form.period_month" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-2 text-sm">
              <template x-for="m in 12" :key="m">
                <option :value="m" x-text="monthNames[m-1]"></option>
              </template>
            </select>
          </div>
        </div>
        <!-- Category -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
          <select x-model.number="form.category_id" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-2 text-sm">
            <template x-for="c in categories" :key="c.id">
              <option :value="c.id" x-text="c.name"></option>
            </template>
          </select>
        </div>
        <!-- Amount -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Amount (EUR)</label>
          <input x-model.number="form.amount" type="number" step="0.01" min="0"
                 class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-2 text-sm">
        </div>
        <!-- Merchant -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Merchant (optional)</label>
          <input x-model="form.merchant" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-2 text-sm">
        </div>
        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes (optional)</label>
          <textarea x-model="form.notes" rows="2" class="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg px-3 py-2 text-sm"></textarea>
        </div>
        <!-- File upload -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Document (optional)</label>
          <template x-if="form.document_id">
            <div class="flex items-center gap-2 text-sm">
              <span class="text-green-600 dark:text-green-400">Document attached</span>
              <button @click="form.document_id = null" class="text-red-600 dark:text-red-400 hover:underline text-xs">Remove</button>
            </div>
          </template>
          <template x-if="!form.document_id">
            <input type="file" @change="uploadFile($event)" class="text-sm text-gray-600 dark:text-gray-300">
          </template>
          <span x-show="uploading" class="text-xs text-gray-400 dark:text-gray-500">Uploading...</span>
        </div>
        <!-- Document not required -->
        <div class="flex items-center gap-2">
          <input type="checkbox" x-model="form.document_not_required" id="docNotReq" class="rounded border-gray-300 dark:border-gray-600">
          <label for="docNotReq" class="text-sm text-gray-700 dark:text-gray-300">Document not required</label>
        </div>
      </div>
      <div x-show="formError" class="mt-3 text-sm text-red-600 dark:text-red-400" x-text="formError"></div>
      <div class="mt-6 flex justify-end gap-3">
        <button @click="showModal = false" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">Cancel</button>
        <button @click="saveExpense()" class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Save</button>
      </div>
    </div>
  </div>

</div>

<script>
function expensesApp() {
  const now = new Date();
  const currentYear = now.getFullYear();

  return {
    expenses: [],
    categories: [],
    total: 0,
    expenseCount: 0,
    filterYear: currentYear,
    filterMonth: 0,
    filterCategory: 0,
    monthNames: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
    showModal: false,
    editingId: null,
    uploading: false,
    formError: '',
    showBulk: false,
    bulkUploading: false,
    bulkProgress: '',
    bulkResults: [],
    bulkFiles: null,
    form: {
      period_year: currentYear,
      period_month: now.getMonth() + 1,
      category_id: 0,
      amount: 0,
      merchant: '',
      notes: '',
      document_id: null,
      document_not_required: false,
    },

    async loadData() {
      const catsResp = await fetch('/api/finance/categories');
      this.categories = await catsResp.json();
      if (this.form.category_id === 0 && this.categories.length > 0) {
        this.form.category_id = this.categories[0].id;
      }

      let url = '/api/finance/expenses?';
      if (this.filterYear) url += 'year=' + this.filterYear + '&';
      if (this.filterMonth) url += 'month=' + this.filterMonth + '&';
      if (this.filterCategory) url += 'category_id=' + this.filterCategory + '&';
      const resp = await fetch(url);
      const data = await resp.json();
      this.expenses = data.expenses;
      this.total = data.total;
      this.expenseCount = data.count;
    },

    csvExportUrl() {
      let url = '/api/finance/expenses/export-csv?';
      if (this.filterYear) url += 'year=' + this.filterYear + '&';
      if (this.filterMonth) url += 'month=' + this.filterMonth + '&';
      return url;
    },

    openCreate() {
      this.editingId = null;
      this.formError = '';
      this.form = {
        period_year: this.filterYear || currentYear,
        period_month: this.filterMonth || (now.getMonth() + 1),
        category_id: this.categories.length > 0 ? this.categories[0].id : 0,
        amount: 0,
        merchant: '',
        notes: '',
        document_id: null,
        document_not_required: false,
      };
      this.showModal = true;
    },

    openEdit(exp) {
      this.editingId = exp.id;
      this.formError = '';
      this.form = {
        period_year: exp.period_year,
        period_month: exp.period_month,
        category_id: exp.category_id,
        amount: exp.amount,
        merchant: exp.merchant || '',
        notes: exp.notes || '',
        document_id: exp.document_id,
        document_not_required: exp.document_not_required,
      };
      this.showModal = true;
    },

    async uploadFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      this.uploading = true;
      const fd = new FormData();
      fd.append('file', file);
      const resp = await fetch('/api/finance/upload', {method: 'POST', body: fd});
      const doc = await resp.json();
      this.form.document_id = doc.id;
      this.uploading = false;
    },

    async saveExpense() {
      this.formError = '';
      if (!this.form.amount || this.form.amount <= 0) {
        this.formError = 'Amount must be positive.';
        return;
      }
      if (!this.form.category_id) {
        this.formError = 'Select a category.';
        return;
      }
      const payload = {
        period_year: this.form.period_year,
        period_month: this.form.period_month,
        category_id: this.form.category_id,
        amount: this.form.amount,
        merchant: this.form.merchant || null,
        notes: this.form.notes || null,
        document_id: this.form.document_id,
        document_not_required: this.form.document_not_required,
      };
      let resp;
      if (this.editingId) {
        resp = await fetch('/api/finance/expenses/' + this.editingId, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
      } else {
        resp = await fetch('/api/finance/expenses', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
      }
      if (!resp.ok) {
        const d = await resp.json().catch(() => ({}));
        this.formError = d.error || 'Error saving expense.';
        return;
      }
      this.showModal = false;
      await this.loadData();
    },

    async deleteExpense(id) {
      await fetch('/api/finance/expenses/' + id, {method: 'DELETE'});
      await this.loadData();
    },

    async bulkImport() {
      const files = this.bulkFiles;
      if (!files || files.length === 0) return;
      this.bulkUploading = true;
      this.bulkResults = [];
      this.bulkProgress = files.length + ' files';
      const fd = new FormData();
      for (let i = 0; i < files.length; i++) {
        fd.append('files', files[i]);
      }
      try {
        const resp = await fetch('/api/finance/expenses/bulk-import', {method: 'POST', body: fd});
        if (resp.ok) {
          const data = await resp.json();
          this.bulkResults = data.expenses;
        }
      } catch (e) {}
      this.bulkUploading = false;
      this.bulkFiles = null;
      await this.loadData();
    },
  }
}
</script>
{% endblock %}
