{% extends "base.html" %}
{% set active_tab = "kanban" %}
{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}
{% block content %}
<div x-data="kanbanApp()" x-init="loadData()" class="h-[calc(100vh-8rem)]">

  <!-- Top bar -->
  <div class="flex flex-wrap items-center gap-3 mb-4">
    <button @click="newTicket.status = ''; showNewModal = true"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
      + Ticket
    </button>
    <button @click="showNewColModal = true"
            class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
      + Columna
    </button>
    <button @click="loadData()"
            class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
      Refresh
    </button>
    <button @click="hideClosed = !hideClosed"
            class="px-4 py-2 rounded-lg text-sm font-medium transition"
            :class="hideClosed
              ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200 dark:bg-yellow-900 dark:text-yellow-200'
              : 'bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200'">
      <span x-text="hideClosed ? 'Cerrados ocultos (' + tickets.filter(t => t.status === 'CERRADO').length + ')' : 'Ocultar cerrados'"></span>
    </button>
    <a href="/api/kanban/export-csv"
       class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
      Exportar CSV
    </a>

    <div class="flex-1"></div>

    <!-- Filters -->
    <select x-model="filterPriority" @change="loadData()"
            class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
      <option value="">Todas prioridades</option>
      <option value="CRITICAL">Critical</option>
      <option value="HIGH">High</option>
      <option value="MEDIUM">Medium</option>
      <option value="LOW">Low</option>
    </select>
    <div class="relative">
      <input x-model="searchQuery" @input.debounce.300ms="loadData()" placeholder="Buscar tickets..."
             class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 w-56 placeholder-gray-400"
             @keydown.escape="searchQuery = ''; loadData()">
      <button x-show="searchQuery" @click="searchQuery = ''; loadData()" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <span class="text-sm text-gray-500 dark:text-gray-400 whitespace-nowrap" x-text="activeTicketCount + ' tickets activos'"></span>
  </div>

  <!-- Board columns -->
  <div class="flex gap-3 h-[calc(100%-3.5rem)] overflow-x-auto pb-2" id="columns-container" x-init="initColumnSortable()">
    <template x-for="col in visibleColumns()" :key="col.id">
      <div class="flex flex-col rounded-xl flex-shrink-0 border-t-4 kanban-column"
           :class="colStyle(col.name).border"
           :data-col-id="col.id">
        <!-- Column header -->
        <div class="px-4 py-3 border-b flex items-center justify-between cursor-grab group"
             :class="colStyle(col.name).header">
          <div class="flex-1 min-w-0">
            <template x-if="editingCol !== col.id">
              <div>
                <h3 class="text-sm font-bold truncate" :class="colStyle(col.name).title" x-text="col.display_name"
                    @dblclick="startEditCol(col)"></h3>
                <div class="flex items-center gap-2 mt-0.5">
                  <span class="text-xs opacity-70" :class="colStyle(col.name).title" x-text="ticketsByCol(col.name).length + ' tickets'"></span>
                  <template x-if="priorityBreakdown(col.name).critical > 0">
                    <span class="text-xs bg-red-200 text-red-800 dark:bg-red-900 dark:text-red-200 px-1.5 rounded-full" x-text="priorityBreakdown(col.name).critical + ' CRIT'"></span>
                  </template>
                  <template x-if="priorityBreakdown(col.name).high > 0">
                    <span class="text-xs bg-orange-200 text-orange-800 dark:bg-orange-900 dark:text-orange-200 px-1.5 rounded-full" x-text="priorityBreakdown(col.name).high + ' HIGH'"></span>
                  </template>
                </div>
              </div>
            </template>
            <template x-if="editingCol === col.id">
              <input x-ref="colEditInput" x-model="editingColName"
                     @keydown.enter="saveColName(col)" @keydown.escape="editingCol = null" @blur="saveColName(col)"
                     class="w-full border dark:border-gray-600 rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
            </template>
          </div>
          <button @click.stop="newTicket.status = col.name; showNewModal = true"
                  class="opacity-0 group-hover:opacity-100 ml-1 text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition" title="Nuevo ticket en esta columna">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          </button>
          <button @click.stop="deleteCol(col)" class="opacity-0 group-hover:opacity-100 ml-1 text-gray-400 hover:text-red-500 transition" title="Eliminar columna">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <!-- Ticket cards -->
        <div class="flex-1 overflow-y-auto p-3 space-y-2 min-h-[100px] transition-colors duration-200"
             :id="'col-' + col.name"
             x-init="initSortable($el, col.name)">
          <template x-for="ticket in ticketsByCol(col.name)" :key="ticket.id">
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm p-3 cursor-grab active:cursor-grabbing border-l-4 border border-gray-200 dark:border-gray-600"
                 :class="priorityBorderClass(ticket.priority)"
                 :data-id="ticket.id"
                 @click="selectTicket(ticket)">
              <div class="flex items-center justify-between mb-1">
                <span x-show="ticket.ticket_id" class="text-sm font-mono font-bold text-green-700 dark:text-green-400 truncate" x-text="ticket.ticket_id"></span>
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full"
                      :class="{
                        'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300': ticket.priority === 'CRITICAL',
                        'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300': ticket.priority === 'HIGH',
                        'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300': ticket.priority === 'MEDIUM',
                        'bg-gray-100 text-gray-600 dark:bg-gray-600 dark:text-gray-300': ticket.priority === 'LOW',
                      }" x-text="ticket.priority"></span>
              </div>
              <div class="text-base font-bold text-gray-900 dark:text-white leading-snug" x-text="ticket.title"></div>
              <div x-show="ticket.description"
                   class="text-sm text-gray-600 dark:text-gray-300 mt-1 line-clamp-2" x-text="ticket.description"></div>
              <div x-show="ticket.notes"
                   class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-2 prose-sm"
                   x-html="renderMarkdown(ticket.notes)"></div>
              <div class="flex items-center justify-between mt-2">
                <div class="flex flex-wrap gap-1">
                  <template x-for="tag in (ticket.tags || []).slice(0, 3)" :key="tag">
                    <span class="bg-gray-100 dark:bg-gray-600 text-gray-600 dark:text-gray-300 text-xs px-1.5 py-0.5 rounded" x-text="tag"></span>
                  </template>
                </div>
                <span class="text-xs text-gray-400 dark:text-gray-500" x-text="timeAgo(ticket.updated_at)"></span>
              </div>
            </div>
          </template>
          <!-- Empty state -->
          <div x-show="ticketsByCol(col.name).length === 0" class="flex items-center justify-center h-20 text-sm text-gray-400 dark:text-gray-500 italic">
            Sin tickets
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- New ticket modal -->
  <div x-show="showNewModal" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-[540px] max-w-[95vw] max-h-[90vh] overflow-y-auto p-6" @click.outside="showNewModal = false; newTicket.status = ''">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Nuevo Ticket</h3>
      <div class="space-y-3">
        <div>
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Cliente <span class="text-red-500">*</span></label>
          <select x-model="newTicket.client_code"
                  class="w-full border rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"
                  :class="newTicket.client_code ? 'border-gray-300 dark:border-gray-600' : 'border-red-400'">
            <option value="" disabled>-- Seleccionar cliente --</option>
            {% for c in clients %}
            <option value="{{ c }}">{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div x-show="newTicket.status" class="text-xs text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 px-3 py-1.5 rounded-lg">
          Columna: <span class="font-semibold" x-text="newTicket.status"></span>
        </div>
        <div>
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">ID Tarea</label>
          <input x-model="newTicket.ticket_id" placeholder="ID Tarea (ej: INC-001)" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm font-mono font-bold text-green-700 dark:text-green-400 bg-white dark:bg-gray-700">
        </div>
        <div>
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Titulo <span class="text-red-500">*</span></label>
          <input x-model="newTicket.title" placeholder="Titulo del ticket" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
        </div>
        <div>
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Descripcion</label>
          <textarea x-model="newTicket.description" placeholder="Descripcion del ticket" rows="2" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"></textarea>
        </div>
        <div>
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Prioridad</label>
          <select x-model="newTicket.priority" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
            <option value="LOW">Low</option><option value="MEDIUM" selected>Medium</option>
            <option value="HIGH">High</option><option value="CRITICAL">Critical</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Notas (Markdown)</label>
          <textarea x-model="newTicket.notes" placeholder="Notas del ticket" rows="4" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm font-mono bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"></textarea>
        </div>
        <div>
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Tags (separados por coma)</label>
          <input x-model="newTicketTagsStr" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"
                 placeholder="bug, urgente, SAP">
        </div>
        <div>
          <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Links (uno por linea)</label>
          <textarea x-model="newTicketLinksStr" rows="2" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm font-mono bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"
                    placeholder="https://jira.example.com/ISSUE-123"></textarea>
        </div>
      </div>
      <div class="flex justify-end gap-3 mt-4">
        <button @click="showNewModal = false; newTicket.status = ''" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancelar</button>
        <button @click="createTicket()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Crear</button>
      </div>
    </div>
  </div>

  <!-- New column modal -->
  <div x-show="showNewColModal" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-96 max-w-[90vw] p-6" @click.outside="showNewColModal = false">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Nueva Columna</h3>
      <div class="space-y-3">
        <input x-model="newColName" placeholder="Nombre de columna" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
      </div>
      <div class="flex justify-end gap-3 mt-4">
        <button @click="showNewColModal = false" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancelar</button>
        <button @click="createCol()" class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Crear</button>
      </div>
    </div>
  </div>

  <!-- Detail modal -->
  <div x-show="selectedTicket" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-[540px] max-w-[95vw] max-h-[90vh] overflow-y-auto p-6" @click.outside="selectedTicket = null">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Detalle de Ticket</h3>
        <button @click="confirmDeleteTicket()" class="text-red-500 hover:text-red-700 text-sm font-medium px-3 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/30 transition" title="Eliminar ticket">
          Eliminar
        </button>
      </div>
      <template x-if="selectedTicket">
        <div class="space-y-3">
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Cliente</label>
            <select disabled
                    class="w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-100 opacity-70 cursor-not-allowed">
              <option selected>{{ active_client or "Sin cliente" }}</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">ID Tarea</label>
            <input x-model="selectedTicket.ticket_id" placeholder="ID Tarea (ej: INC-001)" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm font-mono font-bold text-green-700 dark:text-green-400 bg-white dark:bg-gray-700">
          </div>
          <div class="text-xs text-gray-400 dark:text-gray-500" x-text="'Creado: ' + formatDate(selectedTicket.created_at) + '  |  Modificado: ' + timeAgo(selectedTicket.updated_at)"></div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Titulo</label>
            <input x-model="selectedTicket.title" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Descripcion</label>
            <textarea x-model="selectedTicket.description" rows="2" placeholder="Descripcion del ticket" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"></textarea>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Prioridad</label>
            <select x-model="selectedTicket.priority" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
              <option value="LOW">Low</option><option value="MEDIUM">Medium</option>
              <option value="HIGH">High</option><option value="CRITICAL">Critical</option>
            </select>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Notas (Markdown)</label>
            <textarea x-model="selectedTicket.notes" rows="4" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm font-mono bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"></textarea>
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Tags (separados por coma)</label>
            <input x-model="selectedTicketTagsStr" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"
                   placeholder="bug, urgente, SAP">
          </div>
          <div>
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Links (uno por linea)</label>
            <textarea x-model="selectedTicketLinksStr" rows="2" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm font-mono bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"
                      placeholder="https://jira.example.com/ISSUE-123"></textarea>
          </div>
          <!-- History -->
          <div x-show="ticketHistory.length > 0">
            <label class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1 block">Historial</label>
            <div class="border dark:border-gray-600 rounded-lg divide-y dark:divide-gray-600 max-h-32 overflow-y-auto">
              <template x-for="h in ticketHistory" :key="h.changed_at">
                <div class="px-3 py-1.5 flex items-center gap-2 text-xs text-gray-600 dark:text-gray-300">
                  <span x-text="h.from_status || '(nuevo)'" class="font-mono"></span>
                  <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                  <span x-text="h.to_status" class="font-mono font-semibold"></span>
                  <span class="ml-auto text-gray-400" x-text="timeAgo(h.changed_at)"></span>
                </div>
              </template>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-4">
            <button @click="selectedTicket = null" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cerrar</button>
            <button @click="saveTicket()" class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Guardar</button>
          </div>
        </div>
      </template>
    </div>
  </div>
</div>

<script>
function kanbanApp() {
  return {
    columns: [],
    tickets: [],
    totalTickets: 0,
    showNewModal: false,
    showNewColModal: false,
    selectedTicket: null,
    selectedTicketTagsStr: '',
    selectedTicketLinksStr: '',
    newTicketTagsStr: '',
    newTicketLinksStr: '',
    ticketHistory: [],
    newTicket: {ticket_id: '', title: '', description: '', priority: 'MEDIUM', notes: '', status: '', client_code: '{{ active_client or "" }}'},
    newColName: '',
    editingCol: null,
    editingColName: '',
    hideClosed: false,
    searchQuery: '',
    filterPriority: '',

    get activeTicketCount() {
      return this.tickets.filter(t => t.status !== 'CERRADO').length;
    },

    visibleColumns() {
      if (this.hideClosed) return this.columns.filter(c => c.name !== 'CERRADO');
      return this.columns;
    },

    colStyle(name) {
      const styles = {
        NO_ANALIZADO:                  { header: 'bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600',       border: 'border-gray-400 dark:border-gray-500 bg-gray-50 dark:bg-gray-800',       title: 'text-gray-700 dark:text-gray-200' },
        EN_PROGRESO:                   { header: 'bg-blue-100 dark:bg-blue-900/50 border-blue-200 dark:border-blue-800',     border: 'border-blue-500 dark:border-blue-400 bg-blue-50/50 dark:bg-gray-800',    title: 'text-blue-800 dark:text-blue-200' },
        MAS_INFO:                      { header: 'bg-yellow-100 dark:bg-yellow-900/50 border-yellow-200 dark:border-yellow-800', border: 'border-yellow-500 dark:border-yellow-400 bg-yellow-50/50 dark:bg-gray-800', title: 'text-yellow-800 dark:text-yellow-200' },
        TESTING:                       { header: 'bg-purple-100 dark:bg-purple-900/50 border-purple-200 dark:border-purple-800', border: 'border-purple-500 dark:border-purple-400 bg-purple-50/50 dark:bg-gray-800', title: 'text-purple-800 dark:text-purple-200' },
        PENDIENTE_DE_TRANSPORTE:       { header: 'bg-orange-100 dark:bg-orange-900/50 border-orange-200 dark:border-orange-800', border: 'border-orange-500 dark:border-orange-400 bg-orange-50/50 dark:bg-gray-800', title: 'text-orange-800 dark:text-orange-200' },
        ANALIZADO_PENDIENTE_RESPUESTA: { header: 'bg-cyan-100 dark:bg-cyan-900/50 border-cyan-200 dark:border-cyan-800',    border: 'border-cyan-500 dark:border-cyan-400 bg-cyan-50/50 dark:bg-gray-800',    title: 'text-cyan-800 dark:text-cyan-200' },
        ANALIZADO:                     { header: 'bg-green-100 dark:bg-green-900/50 border-green-200 dark:border-green-800', border: 'border-green-500 dark:border-green-400 bg-green-50/50 dark:bg-gray-800', title: 'text-green-800 dark:text-green-200' },
        CERRADO:                       { header: 'bg-emerald-100 dark:bg-emerald-900/50 border-emerald-200 dark:border-emerald-800', border: 'border-emerald-500 dark:border-emerald-400 bg-emerald-50/50 dark:bg-gray-800', title: 'text-emerald-800 dark:text-emerald-200' },
      };
      return styles[name] || { header: 'bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700', border: 'border-gray-400 dark:border-gray-500 bg-gray-50 dark:bg-gray-800', title: 'text-gray-700 dark:text-gray-200' };
    },

    priorityBorderClass(priority) {
      return {
        'border-l-red-500': priority === 'CRITICAL',
        'border-l-orange-500': priority === 'HIGH',
        'border-l-blue-400': priority === 'MEDIUM',
        'border-l-gray-300 dark:border-l-gray-500': priority === 'LOW',
      };
    },

    priorityBreakdown(colName) {
      const col = this.ticketsByCol(colName);
      return {
        critical: col.filter(t => t.priority === 'CRITICAL').length,
        high: col.filter(t => t.priority === 'HIGH').length,
      };
    },

    ticketsByCol(colName) {
      return this.tickets.filter(t => t.status === colName);
    },

    renderMarkdown(text) {
      if (!text) return '';
      try {
        const short = text.length > 120 ? text.substring(0, 120) + '...' : text;
        return marked.parseInline(short);
      } catch(e) { return text; }
    },

    timeAgo(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      if (diffMins < 1) return 'ahora';
      if (diffMins < 60) return diffMins + ' min';
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return diffHours + 'h';
      const diffDays = Math.floor(diffHours / 24);
      if (diffDays === 1) return 'ayer';
      if (diffDays < 30) return diffDays + 'd';
      const diffMonths = Math.floor(diffDays / 30);
      return diffMonths + ' mes' + (diffMonths > 1 ? 'es' : '');
    },

    formatDate(dateStr) {
      if (!dateStr) return '';
      return new Date(dateStr).toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric'});
    },

    async loadData() {
      const params = new URLSearchParams();
      if (this.searchQuery.trim()) params.set('search', this.searchQuery.trim());
      if (this.filterPriority) params.set('priority', this.filterPriority);
      const qs = params.toString() ? '?' + params.toString() : '';

      const [colResp, ticketResp] = await Promise.all([
        fetch('/api/kanban/columns'),
        fetch('/api/kanban/tickets' + qs),
      ]);
      this.columns = await colResp.json();
      const data = await ticketResp.json();
      this.tickets = data.tickets;
      this.totalTickets = data.total;
    },

    async createTicket() {
      if (!this.newTicket.client_code || !this.newTicket.client_code.trim()) {
        alert('Debe seleccionar un cliente.');
        return;
      }
      if (!this.newTicket.title.trim()) {
        alert('El titulo es obligatorio.');
        return;
      }
      const tags = this.newTicketTagsStr.split(',').map(s => s.trim()).filter(Boolean);
      const links = this.newTicketLinksStr.split('\n').map(s => s.trim()).filter(Boolean);
      const payload = {...this.newTicket, tags: tags, links: links};
      const resp = await fetch('/api/kanban/tickets', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        alert('Error al crear ticket: ' + (data.error || resp.statusText));
        return;
      }
      this.newTicket = {ticket_id: '', title: '', description: '', priority: 'MEDIUM', notes: '', status: '', client_code: '{{ active_client or "" }}'};
      this.newTicketTagsStr = '';
      this.newTicketLinksStr = '';
      this.showNewModal = false;
      await this.loadData();
    },

    async selectTicket(ticket) {
      this.selectedTicket = {...ticket};
      this.selectedTicketTagsStr = (ticket.tags || []).join(', ');
      this.selectedTicketLinksStr = (ticket.links || []).join('\n');
      // Load history
      try {
        const resp = await fetch('/api/kanban/tickets/' + ticket.id + '/history');
        this.ticketHistory = await resp.json();
      } catch(e) { this.ticketHistory = []; }
    },

    async saveTicket() {
      if (!this.selectedTicket) return;
      const tags = this.selectedTicketTagsStr.split(',').map(s => s.trim()).filter(Boolean);
      const links = this.selectedTicketLinksStr.split('\n').map(s => s.trim()).filter(Boolean);
      const resp = await fetch('/api/kanban/tickets/' + this.selectedTicket.id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          title: this.selectedTicket.title,
          ticket_id: this.selectedTicket.ticket_id,
          description: this.selectedTicket.description,
          priority: this.selectedTicket.priority,
          notes: this.selectedTicket.notes,
          tags: tags,
          links: links,
        }),
      });
      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        alert('Error al guardar: ' + (data.error || resp.statusText));
        return;
      }
      this.selectedTicket = null;
      await this.loadData();
    },

    async confirmDeleteTicket() {
      if (!this.selectedTicket) return;
      const name = this.selectedTicket.ticket_id || this.selectedTicket.title;
      if (!confirm('Eliminar ticket "' + name + '"? Esta accion no se puede deshacer.')) return;
      const resp = await fetch('/api/kanban/tickets/' + this.selectedTicket.id, {method: 'DELETE'});
      if (!resp.ok) {
        const data = await resp.json().catch(() => ({}));
        alert('Error al eliminar: ' + (data.error || resp.statusText));
        return;
      }
      this.selectedTicket = null;
      await this.loadData();
    },

    // Column management
    async createCol() {
      const name = this.newColName.trim();
      if (!name) return;
      const resp = await fetch('/api/kanban/columns', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name.toUpperCase().replace(/\s+/g, '_'), display_name: name}),
      });
      if (resp.ok) {
        this.newColName = '';
        this.showNewColModal = false;
        await this.loadData();
      } else {
        const data = await resp.json();
        alert(data.error || 'Error al crear columna');
      }
    },

    startEditCol(col) {
      this.editingCol = col.id;
      this.editingColName = col.display_name;
      this.$nextTick(() => { if (this.$refs.colEditInput) this.$refs.colEditInput.focus(); });
    },

    async saveColName(col) {
      if (this.editingCol !== col.id) return;
      const newName = this.editingColName.trim();
      this.editingCol = null;
      if (!newName || newName === col.display_name) return;
      await fetch('/api/kanban/columns/' + col.id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({display_name: newName}),
      });
      await this.loadData();
    },

    async deleteCol(col) {
      const count = this.ticketsByCol(col.name).length;
      if (count > 0) {
        alert('No se puede eliminar "' + col.display_name + '": tiene ' + count + ' ticket(s). Muevalos primero.');
        return;
      }
      if (!confirm('Eliminar columna "' + col.display_name + '"?')) return;
      const resp = await fetch('/api/kanban/columns/' + col.id, {method: 'DELETE'});
      if (resp.ok) {
        await this.loadData();
      } else {
        const data = await resp.json();
        alert(data.error || 'Error al eliminar columna');
      }
    },

    initColumnSortable() {
      const app = this;
      const el = document.getElementById('columns-container');
      if (!el) return;
      Sortable.create(el, {
        animation: 200,
        handle: '.cursor-grab',
        ghostClass: 'opacity-30',
        onEnd: async function() {
          const ids = Array.from(el.querySelectorAll('[data-col-id]')).map(e => parseInt(e.dataset.colId));
          await fetch('/api/kanban/columns/reorder', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ordered_ids: ids}),
          });
          await app.loadData();
        }
      });
    },

    initSortable(el, colName) {
      const app = this;
      Sortable.create(el, {
        group: 'kanban',
        animation: 200,
        ghostClass: 'opacity-30',
        dragClass: 'shadow-lg',
        onStart: function(evt) {
          document.querySelectorAll('[id^="col-"]').forEach(c => {
            if (c !== evt.from) c.classList.add('bg-blue-50/50', 'dark:bg-blue-900/20');
          });
        },
        onEnd: async function(evt) {
          document.querySelectorAll('[id^="col-"]').forEach(c => {
            c.classList.remove('bg-blue-50/50', 'dark:bg-blue-900/20');
          });
          const ticketId = evt.item.dataset.id;
          const targetCol = evt.to.id.replace('col-', '');
          if (ticketId && targetCol) {
            await fetch('/api/kanban/tickets/' + ticketId + '/move', {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({status: targetCol}),
            });
            await app.loadData();
          }
        }
      });
    },
  }
}
</script>
{% endblock %}
