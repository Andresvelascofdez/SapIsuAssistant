{% extends "base.html" %}
{% set active_tab = "kanban" %}
{% block content %}
<div x-data="kanbanApp()" x-init="loadData()" class="h-[calc(100vh-8rem)]">

  <!-- Top bar -->
  <div class="flex items-center gap-4 mb-6">
    <button @click="showNewModal = true"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
      + New Ticket
    </button>
    <button @click="showNewColModal = true"
            class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
      + Column
    </button>
    <button @click="loadData()"
            class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 px-4 py-2 rounded-lg text-sm font-medium transition">
      Refresh
    </button>
    <button @click="hideClosed = !hideClosed"
            class="px-4 py-2 rounded-lg text-sm font-medium transition"
            :class="hideClosed
              ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200 dark:bg-yellow-900 dark:text-yellow-200 dark:hover:bg-yellow-800'
              : 'bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600'">
      <span x-text="hideClosed ? 'Cerrados ocultos (' + ticketsByCol('CERRADO').length + ')' : 'Ocultar cerrados'"></span>
    </button>
    <div class="relative">
      <input x-model="searchQuery" placeholder="Buscar por ID..."
             class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100 w-48 placeholder-gray-400"
             @keydown.escape="searchQuery = ''">
      <button x-show="searchQuery" @click="searchQuery = ''" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <span class="text-sm text-gray-500 dark:text-gray-400" x-text="activeTicketCount + ' tickets activos'"></span>
  </div>

  <!-- Board columns (draggable) -->
  <div class="flex gap-4 h-[calc(100%-4rem)] overflow-x-auto pb-2" id="columns-container" x-init="initColumnSortable()">
    <template x-for="col in visibleColumns()" :key="col.id">
      <div class="flex flex-col rounded-xl min-w-[280px] w-[280px] flex-shrink-0 border-t-4"
           :class="colStyle(col.name).border"
           :data-col-id="col.id">
        <!-- Column header -->
        <div class="px-4 py-3 border-b flex items-center justify-between cursor-grab group"
             :class="colStyle(col.name).header">
          <div class="flex-1 min-w-0">
            <template x-if="editingCol !== col.id">
              <div>
                <h3 class="text-sm font-bold truncate" :class="colStyle(col.name).title" x-text="col.display_name"
                    @dblclick="startEditCol(col)"></h3>
                <span class="text-xs opacity-70" :class="colStyle(col.name).title" x-text="ticketsByCol(col.name).length + ' tickets'"></span>
              </div>
            </template>
            <template x-if="editingCol === col.id">
              <input x-ref="colEditInput" x-model="editingColName"
                     @keydown.enter="saveColName(col)" @keydown.escape="editingCol = null" @blur="saveColName(col)"
                     class="w-full border dark:border-gray-600 rounded px-2 py-1 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
            </template>
          </div>
          <button @click.stop="deleteCol(col)" class="opacity-0 group-hover:opacity-100 ml-2 text-gray-400 hover:text-red-500 transition text-sm" title="Delete column">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
        <!-- Ticket cards -->
        <div class="flex-1 overflow-y-auto p-3 space-y-2 min-h-[100px]"
             :id="'col-' + col.name"
             x-init="initSortable($el, col.name)">
          <template x-for="ticket in ticketsByCol(col.name)" :key="ticket.id">
            <div class="bg-white dark:bg-gray-700 rounded-lg shadow-sm border-2 border-green-400 dark:border-green-600 p-3 cursor-grab active:cursor-grabbing"
                 :data-id="ticket.id"
                 @click="selectTicket(ticket)">
              <div class="flex items-center justify-between mb-1">
                <span x-show="ticket.ticket_id" class="text-sm font-mono font-bold text-green-700 dark:text-green-400 truncate" x-text="ticket.ticket_id"></span>
                <span class="text-xs font-semibold px-2 py-0.5 rounded-full"
                      :class="{
                        'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300': ticket.priority === 'CRITICAL',
                        'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300': ticket.priority === 'HIGH',
                        'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300': ticket.priority === 'MEDIUM',
                        'bg-gray-100 text-gray-600 dark:bg-gray-600 dark:text-gray-300': ticket.priority === 'LOW',
                      }" x-text="ticket.priority"></span>
              </div>
              <div class="text-base font-bold text-gray-900 dark:text-white leading-snug" x-text="ticket.title"></div>
              <div x-show="ticket.notes" class="text-xs text-gray-500 dark:text-gray-400 mt-1 truncate" x-text="ticket.notes"></div>
            </div>
          </template>
        </div>
      </div>
    </template>
  </div>

  <!-- New ticket modal -->
  <div x-show="showNewModal" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-96 p-6" @click.outside="showNewModal = false">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">New Ticket</h3>
      <div class="space-y-3">
        <input x-model="newTicket.title" placeholder="Title" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
        <select x-model="newTicket.priority" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
          <option value="LOW">Low</option><option value="MEDIUM" selected>Medium</option>
          <option value="HIGH">High</option><option value="CRITICAL">Critical</option>
        </select>
        <textarea x-model="newTicket.notes" placeholder="Notes (optional)" rows="3" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"></textarea>
      </div>
      <div class="flex justify-end gap-3 mt-4">
        <button @click="showNewModal = false" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
        <button @click="createTicket()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Create</button>
      </div>
    </div>
  </div>

  <!-- New column modal -->
  <div x-show="showNewColModal" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-96 p-6" @click.outside="showNewColModal = false">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">New Column</h3>
      <div class="space-y-3">
        <input x-model="newColName" placeholder="Column name (e.g. Testing)" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
      </div>
      <div class="flex justify-end gap-3 mt-4">
        <button @click="showNewColModal = false" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Cancel</button>
        <button @click="createCol()" class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Create</button>
      </div>
    </div>
  </div>

  <!-- Detail modal -->
  <div x-show="selectedTicket" x-transition class="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl w-[480px] p-6" @click.outside="selectedTicket = null">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 mb-4">Ticket Detail</h3>
      <template x-if="selectedTicket">
        <div class="space-y-3">
          <div x-show="selectedTicket.ticket_id" class="text-xs font-mono text-gray-400 dark:text-gray-500" x-text="selectedTicket.ticket_id"></div>
          <input x-model="selectedTicket.title" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
          <select x-model="selectedTicket.priority" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100">
            <option value="LOW">Low</option><option value="MEDIUM">Medium</option>
            <option value="HIGH">High</option><option value="CRITICAL">Critical</option>
          </select>
          <textarea x-model="selectedTicket.notes" rows="3" class="w-full border dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-100"></textarea>
          <div class="flex justify-end gap-3 mt-4">
            <button @click="selectedTicket = null" class="px-4 py-2 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">Close</button>
            <button @click="saveTicket()" class="bg-sap-600 hover:bg-sap-700 text-white px-4 py-2 rounded-lg text-sm font-medium">Save</button>
          </div>
        </div>
      </template>
    </div>
  </div>
</div>

<script>
function kanbanApp() {
  return {
    columns: [],
    tickets: [],
    showNewModal: false,
    showNewColModal: false,
    selectedTicket: null,
    statusText: '',
    newTicket: {title: '', priority: 'MEDIUM', notes: ''},
    newColName: '',
    editingCol: null,
    editingColName: '',
    hideClosed: false,
    searchQuery: '',

    get activeTicketCount() {
      return this.tickets.filter(t => t.status !== 'CERRADO').length;
    },

    visibleColumns() {
      if (this.hideClosed) return this.columns.filter(c => c.name !== 'CERRADO');
      return this.columns;
    },

    colStyle(name) {
      const styles = {
        NO_ANALIZADO:                  { header: 'bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600',       border: 'border-gray-400 dark:border-gray-500 bg-gray-50 dark:bg-gray-800',       title: 'text-gray-700 dark:text-gray-200' },
        EN_PROGRESO:                   { header: 'bg-blue-100 dark:bg-blue-900/50 border-blue-200 dark:border-blue-800',     border: 'border-blue-500 dark:border-blue-400 bg-blue-50/50 dark:bg-gray-800',    title: 'text-blue-800 dark:text-blue-200' },
        MAS_INFO:                      { header: 'bg-yellow-100 dark:bg-yellow-900/50 border-yellow-200 dark:border-yellow-800', border: 'border-yellow-500 dark:border-yellow-400 bg-yellow-50/50 dark:bg-gray-800', title: 'text-yellow-800 dark:text-yellow-200' },
        TESTING:                       { header: 'bg-purple-100 dark:bg-purple-900/50 border-purple-200 dark:border-purple-800', border: 'border-purple-500 dark:border-purple-400 bg-purple-50/50 dark:bg-gray-800', title: 'text-purple-800 dark:text-purple-200' },
        PENDIENTE_DE_TRANSPORTE:       { header: 'bg-orange-100 dark:bg-orange-900/50 border-orange-200 dark:border-orange-800', border: 'border-orange-500 dark:border-orange-400 bg-orange-50/50 dark:bg-gray-800', title: 'text-orange-800 dark:text-orange-200' },
        ANALIZADO_PENDIENTE_RESPUESTA: { header: 'bg-cyan-100 dark:bg-cyan-900/50 border-cyan-200 dark:border-cyan-800',    border: 'border-cyan-500 dark:border-cyan-400 bg-cyan-50/50 dark:bg-gray-800',    title: 'text-cyan-800 dark:text-cyan-200' },
        ANALIZADO:                     { header: 'bg-green-100 dark:bg-green-900/50 border-green-200 dark:border-green-800', border: 'border-green-500 dark:border-green-400 bg-green-50/50 dark:bg-gray-800', title: 'text-green-800 dark:text-green-200' },
        CERRADO:                       { header: 'bg-emerald-100 dark:bg-emerald-900/50 border-emerald-200 dark:border-emerald-800', border: 'border-emerald-500 dark:border-emerald-400 bg-emerald-50/50 dark:bg-gray-800', title: 'text-emerald-800 dark:text-emerald-200' },
      };
      return styles[name] || { header: 'bg-gray-100 dark:bg-gray-800 border-gray-200 dark:border-gray-700', border: 'border-gray-400 dark:border-gray-500 bg-gray-50 dark:bg-gray-800', title: 'text-gray-700 dark:text-gray-200' };
    },

    ticketsByCol(colName) {
      let filtered = this.tickets.filter(t => t.status === colName);
      if (this.searchQuery.trim()) {
        const q = this.searchQuery.trim().toLowerCase();
        filtered = filtered.filter(t => (t.ticket_id || '').toLowerCase().includes(q));
      }
      return filtered;
    },

    async loadData() {
      const [colResp, ticketResp] = await Promise.all([
        fetch('/api/kanban/columns'),
        fetch('/api/kanban/tickets'),
      ]);
      this.columns = await colResp.json();
      this.tickets = await ticketResp.json();
      this.statusText = this.tickets.length + ' tickets';
    },

    async createTicket() {
      if (!this.newTicket.title.trim()) return;
      await fetch('/api/kanban/tickets', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(this.newTicket),
      });
      this.newTicket = {title: '', priority: 'MEDIUM', notes: ''};
      this.showNewModal = false;
      await this.loadData();
    },

    selectTicket(ticket) {
      this.selectedTicket = {...ticket};
    },

    async saveTicket() {
      if (!this.selectedTicket) return;
      await fetch('/api/kanban/tickets/' + this.selectedTicket.id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(this.selectedTicket),
      });
      this.selectedTicket = null;
      await this.loadData();
    },

    // Column management
    async createCol() {
      const name = this.newColName.trim();
      if (!name) return;
      const resp = await fetch('/api/kanban/columns', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: name.toUpperCase().replace(/\s+/g, '_'), display_name: name}),
      });
      if (resp.ok) {
        this.newColName = '';
        this.showNewColModal = false;
        await this.loadData();
      } else {
        const data = await resp.json();
        alert(data.error || 'Failed to create column');
      }
    },

    startEditCol(col) {
      this.editingCol = col.id;
      this.editingColName = col.display_name;
      this.$nextTick(() => { if (this.$refs.colEditInput) this.$refs.colEditInput.focus(); });
    },

    async saveColName(col) {
      if (this.editingCol !== col.id) return;
      const newName = this.editingColName.trim();
      this.editingCol = null;
      if (!newName || newName === col.display_name) return;
      await fetch('/api/kanban/columns/' + col.id, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({display_name: newName}),
      });
      await this.loadData();
    },

    async deleteCol(col) {
      const count = this.ticketsByCol(col.name).length;
      if (count > 0) {
        alert('Cannot delete column "' + col.display_name + '": it has ' + count + ' ticket(s). Move them first.');
        return;
      }
      if (!confirm('Delete column "' + col.display_name + '"?')) return;
      const resp = await fetch('/api/kanban/columns/' + col.id, {method: 'DELETE'});
      if (resp.ok) {
        await this.loadData();
      } else {
        const data = await resp.json();
        alert(data.error || 'Failed to delete column');
      }
    },

    initColumnSortable() {
      const app = this;
      const el = document.getElementById('columns-container');
      if (!el) return;
      Sortable.create(el, {
        animation: 200,
        handle: '.cursor-grab',
        ghostClass: 'opacity-30',
        onEnd: async function() {
          const ids = Array.from(el.querySelectorAll('[data-col-id]')).map(e => parseInt(e.dataset.colId));
          await fetch('/api/kanban/columns/reorder', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ordered_ids: ids}),
          });
          await app.loadData();
        }
      });
    },

    initSortable(el, colName) {
      const app = this;
      Sortable.create(el, {
        group: 'kanban',
        animation: 200,
        ghostClass: 'opacity-30',
        dragClass: 'shadow-lg',
        onEnd: async function(evt) {
          const ticketId = evt.item.dataset.id;
          const targetCol = evt.to.id.replace('col-', '');
          if (ticketId && targetCol) {
            await fetch('/api/kanban/tickets/' + ticketId + '/move', {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({status: targetCol}),
            });
            await app.loadData();
          }
        }
      });
    },
  }
}
</script>
{% endblock %}
